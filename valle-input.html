<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="valle-input">
  <template>

    <style>

      :host {
        display: inline-block;
        position: relative;
        overflow: hidden;
      }

      .visual-hidden {
        position: absolute;
        left: -10000px;
      }

    </style>

    <label id="inputLabel">[[label]]</label>

    <input
      id="input"
      type=[[type]]
      placeholder=[[placeholder]]
      pattern=[[RegEx]]
      aria-labelledby="inputLabel"
      aria-describedby="description"
    >

    <template is="dom-if" if={{_isNoError(helpertext,error)}}>
      <small id="description">[[helpertext]]</small>
    </template>

    <template is="dom-if" if=[[error]]>
      <span role="alert" id="description">
        [[errortext]]<small class="visual-hidden">: [[helpertext]]</small>
      </span>
    </template>

  </template>

  <script>
    class valleInput extends Polymer.Element {

      static get is() { return 'valle-input'; }

      ready() {
        super.ready();

        this.addEventListener('keyup', this._bindValue.bind(this));

        if (this.required) {
          this.addEventListener('blur', this._validateRequired.bind(this));
        }

        if (this.pattern) {
          this.addEventListener('blur', () => this._validate(this.pattern));
        } else if (this.validateby === 'name') {
          this.addEventListener('blur', () => this._validate('[A-z][ ][A-z]'));
        }

        if (this.maxlength) {
          this._maxlengthControl.bind(this, this.maxlength)();
        }
      }

      _bindValue() {
        this.value = this.$.input.value;
      }

      _isNoError(helpertext, error) {
        return helpertext && !error;
      }

      _toogleRequired(required) {
        required
        ? this.$.input.setAttribute('aria-required', true)
        : this.$.input.removeAttribute('aria-required')
      }

      _toogleDisabled(disabled) {
        disabled
        ? this.$.input.setAttribute('disabled', true)
        : this.$.input.removeAttribute('disabled')
      }

      _validateRequired() {
        const valueInput = this.$.input.value;
        const isEmpty = valueInput.length === 0;

        isEmpty
        ? this.setAttribute('error', true)
        : this.removeAttribute('error')
      }

      _maxlengthControl(maxlength) {
        const input = this.$.input;

        input.setAttribute('maxlength', maxlength);

      }

      _validate(pattern) {
        const valueInput = this.$.input.value;

        const regExp = new RegExp(pattern);
        const result = regExp.test(valueInput);

        !result
        ? this.setAttribute('error', true)
        : this.removeAttribute('error')
      }

      static get properties() {
        return {
          label: String,
          type: {
            type: String,
            value: "text"
          },
          validateby: String,
          placeholder: String,
          helpertext: String,
          maxlength: Number,
          errortext: String,
          pattern: String,
          value: String,
          error: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          },
          required: {
            type: Boolean,
            value: false,
            reflectToAttribute: true,
            observer: '_toogleRequired'
          },
          disabled: {
            type: Boolean,
            value: false,
            reflectToAttribute: true,
            observer: '_toogleDisabled'
          }
        };
      }
    }

    window.customElements.define(valleInput.is, valleInput);
  </script>
</dom-module>
